Bootstrap: docker
From: condaforge/miniforge3:latest

%labels
    Author Peter
    Description "MiRNATarget container with FASTA3 (ssearch36) and Python from conda-forge/bioconda"

%environment
    export PATH=/opt/conda/bin:$PATH
    export PYTHONPATH=/opt/miRNATarget/python_packages:$PYTHONPATH
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8

%post
    # Ensure conda is available
    export PATH=/opt/conda/bin:$PATH

    # Use only conda-forge and bioconda to avoid ToS issues
    conda config --system --remove-key channels || true
    conda config --system --add channels conda-forge
    conda config --system --add channels bioconda
    conda config --system --set channel_priority strict

    # Update conda
    conda update -y conda

    # Install FASTA3 (ssearch36) and Python 3.11
    conda install -y \
        python=3.11 \
        fasta3=36.3.8i=h7b50bb2_3 \
        git \
        pip

    # Verify ssearch36 is installed
    which ssearch36 || echo "⚠️ ssearch36 not found in PATH"

    # Clone MiRNATarget repository
    mkdir -p /MiRNATarget
    git clone https://github.com/jtremblay/MiRNATarget.git /MiRNATarget

    # Create local python package dir
    mkdir -p /opt/miRNATarget/python_packages

    # Install Python dependencies
    pip install --no-cache-dir --target=/opt/miRNATarget/python_packages \
        biopython pandas numpy

    # Clean up
    conda clean -afy

%environment
    export PATH=/opt/conda/bin:$PATH
    export PYTHONPATH=/opt/miRNATarget/python_packages:$PYTHONPATH

%runscript
    echo "MiRNATarget container ready."
    echo "Example usage:"
    echo "  ssearch36 -h"
    echo "  python /MiRNATarget/parse_mirna_targets.py -i input.fa -o output.txt"
